// var data = {
//     "children": [
//         {
//             "children": [
//                 {
//                     "size": 6087846,
//                     "name": "sub-meguk0354_T1w.nii.gz",
//                     "type": "file",
//                     "ext": "nii.gz"
//                 }
//             ],
//             "name": "anat",
//             "type": "directory"
//         },
//         {
//             "children": [
//                 {
//                     "children": [
//                         {
//                             "size": 826,
//                             "name": "sub-meguk0354_task-resteyesopen.hc",
//                             "type": "file",
//                             "ext": "hc"
//                         },
//                         {
//                             "size": 2654,
//                             "name": "sub-meguk0354_task-resteyesopen.infods",
//                             "type": "file",
//                             "ext": "infods"
//                         },
//                         {
//                             "children": [
//                                 {
//                                     "size": 3113049,
//                                     "name": "hz.res4",
//                                     "type": "file",
//                                     "ext": "res4"
//                                 },
//                                 {
//                                     "size": 234,
//                                     "name": "hz.newds",
//                                     "type": "file",
//                                     "ext": "newds"
//                                 },
//                                 {
//                                     "size": 0,
//                                     "name": "BadChannels",
//                                     "type": "file",
//                                     "ext": ""
//                                 },
//                                 {
//                                     "size": 66,
//                                     "name": "hz.hc",
//                                     "type": "file",
//                                     "ext": "hc"
//                                 },
//                                 {
//                                     "size": 470,
//                                     "name": "params.dsc",
//                                     "type": "file",
//                                     "ext": "dsc"
//                                 },
//                                 {
//                                     "size": 2527,
//                                     "name": "hz.infods",
//                                     "type": "file",
//                                     "ext": "infods"
//                                 },
//                                 {
//                                     "size": 0,
//                                     "name": "bad.segments",
//                                     "type": "file",
//                                     "ext": "segments"
//                                 },
//                                 {
//                                     "size": 1185,
//                                     "name": "processing.cfg",
//                                     "type": "file",
//                                     "ext": "cfg"
//                                 },
//                                 {
//                                     "size": 36089,
//                                     "name": "hz.acq",
//                                     "type": "file",
//                                     "ext": "acq"
//                                 },
//                                 {
//                                     "size": 1079048,
//                                     "name": "hz.meg4",
//                                     "type": "file",
//                                     "ext": "meg4"
//                                 },
//                                 {
//                                     "size": 336,
//                                     "name": "ClassFile.cls",
//                                     "type": "file",
//                                     "ext": "cls"
//                                 }
//                             ],
//                             "name": "hz.ds",
//                             "type": "directory"
//                         },
//                         {
//                             "size": 0,
//                             "name": "BadChannels",
//                             "type": "file",
//                             "ext": ""
//                         },
//                         {
//                             "size": 2654,
//                             "name": "sub-meguk0354_task-resteyesopen.infods.bak",
//                             "type": "file",
//                             "ext": "infods.bak"
//                         },
//                         {
//                             "size": 469,
//                             "name": "params.dsc",
//                             "type": "file",
//                             "ext": "dsc"
//                         },
//                         {
//                             "size": 3329305,
//                             "name": "sub-meguk0354_task-resteyesopen.res4",
//                             "type": "file",
//                             "ext": "res4"
//                         },
//                         {
//                             "size": 0,
//                             "name": "bad.segments",
//                             "type": "file",
//                             "ext": "segments"
//                         },
//                         {
//                             "size": 61239,
//                             "name": "sub-meguk0354_task-resteyesopen.acq",
//                             "type": "file",
//                             "ext": "acq"
//                         },
//                         {
//                             "size": 1201,
//                             "name": "processing.cfg",
//                             "type": "file",
//                             "ext": "cfg"
//                         },
//                         {
//                             "size": 584136008,
//                             "name": "sub-meguk0354_task-resteyesopen.meg4",
//                             "type": "file",
//                             "ext": "meg4"
//                         },
//                         {
//                             "size": 566,
//                             "name": "MarkerFile.mrk",
//                             "type": "file",
//                             "ext": "mrk"
//                         },
//                         {
//                             "size": 330,
//                             "name": "ClassFile.cls",
//                             "type": "file",
//                             "ext": "cls"
//                         },
//                         {
//                             "size": 357,
//                             "name": "sub-meguk0354_task-resteyesopen.newds",
//                             "type": "file",
//                             "ext": "newds"
//                         }
//                     ],
//                     "name": "sub-meguk0354_task-resteyesopen.ds",
//                     "type": "directory"
//                 },
//                 {
//                     "size": 1239,
//                     "name": "sub-meguk0354_task-resteyesopen_meg.json",
//                     "type": "file",
//                     "ext": "json"
//                 },
//                 {
//                     "size": 799,
//                     "name": "sub-meguk0354_fid.json",
//                     "type": "file",
//                     "ext": "json"
//                 },
//                 {
//                     "size": 855,
//                     "name": "sub-meguk0354_task-resteyesopen_meg.json.zip",
//                     "type": "file",
//                     "ext": "json.zip"
//                 },
//                 {
//                     "size": 17271,
//                     "name": "sub-meguk0354_headshape.pos",
//                     "type": "file",
//                     "ext": "pos"
//                 },
//                 {
//                     "size": 315,
//                     "name": "sub-meguk0354_fidinfo.txt",
//                     "type": "file",
//                     "ext": "txt"
//                 }
//             ],
//             "name": "meg",
//             "type": "directory"
//         }
//     ],
//     "name": "sub-meguk0354",
//     "type": "directory"
// };

    // console.log(data);

// https://stackoverflow.com/a/18650828
function formatBytes(a,b){if(0==a)return"0 Bytes";var c=1024,d=b||2,e=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],f=Math.floor(Math.log(a)/Math.log(c));return parseFloat((a/Math.pow(c,f)).toFixed(d))+" "+e[f]}


// http://bl.ocks.org/thehogfather/0e48ec486abbd5be17d7

function get_resource_tree(resource_url) {
    console.log('Trying to get ' +  resource_url);

    var id = 0;
    d3.json(resource_url, function (err, data) {
        var tree = d3.layout.treelist()
            .childIndent(10)
            .nodeHeight(30);
        var ul = d3.select("#filetree").append("ul").classed("treelist", "true");

        function render(data, parent) {
            var nodes = tree.nodes(data),
                duration = 250;

            function toggleChildren(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            }

            var nodeEls = ul.selectAll("li.node").data(nodes, function (d) {
                d.id = d.id || ++id;
                return d.id;
            });
            //entered nodes
            var entered = nodeEls.enter().append("li").classed("node", true)
                .style("top", parent.y + "px")
                .style("opacity", 0)
                .style("height", tree.nodeHeight() + "px")
                .on("click", function (d) {
                    toggleChildren(d);
                    render(data, d);
                })
                .on("mouseover", function (d) {
                    d3.select(this).classed("selected", true);
                })
                .on("mouseout", function (d) {
                    d3.selectAll(".selected").classed("selected", false);
                });
            //add arrows if it is a folder
            entered.append("span").attr("class", function (d) {
                var icon = d.children ? " glyphicon-chevron-down"
                    : d._children ? "glyphicon-chevron-right" : "";
                return "caret glyphicon " + icon;
            });
            //add icons for folder for file
            entered.append("span").attr("class", function (d) {
                var icon = d.children || d._children ? "glyphicon-folder-close"
                    : "glyphicon-file";
                return "glyphicon " + icon;
            });
            //add text
            entered.append("span").attr("class", "filename")
                .html(function (d) {
                    return d.name;
                });
            entered.append("span").attr("class", "filesize")
                .html(function (d) {
                    if (d.size) {
                        return ' ' + formatBytes(parseInt(d.size), 2);
                    } else {
                        return ''
                    }
                });
            //update caret direction
            nodeEls.select("span.caret").attr("class", function (d) {
                var icon = d.children ? " glyphicon-chevron-down"
                    : d._children ? "glyphicon-chevron-right" : "";
                return "caret glyphicon " + icon;
            });
            //update position with transition
            nodeEls.transition().duration(duration)
                .style("top", function (d) {
                    return (d.y - tree.nodeHeight()) + "px";
                })
                .style("left", function (d) {
                    return d.x + "px";
                })
                .style("opacity", 1);
            nodeEls.exit().remove();
        }

        render(data, data);

    });
}